# æµå¼è¯·æ±‚é‡è¯•å®ç°å®Œæˆ âœ…

## å®ç°æ¦‚è§ˆ

æµå¼è¯·æ±‚é‡è¯•æœºåˆ¶å·²ç»å®Œå…¨å®ç°ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### âœ… å·²å®ŒæˆåŠŸèƒ½

1. **SSEè½¬æ¢å·¥å…·** (`src/utils/sseConverter.js`)
   - `convertJsonToSSEStream()` - å°†JSONå“åº”è½¬æ¢ä¸ºSSEæµ
   - `sendSSEError()` - å‘é€SSEæ ¼å¼çš„é”™è¯¯
   - `isStreamRetryableError()` - åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•

2. **æµå¼è¯·æ±‚é‡è¯•å¾ªç¯** (`src/routes/api.js` ç¬¬169-587è¡Œ)
   - è¿æ¥çº§é‡è¯•ï¼šæœ€å¤šå°è¯•3ä¸ªä¸åŒçš„è´¦æˆ·
   - è‡ªåŠ¨æ’é™¤å¤±è´¥çš„è´¦æˆ·ï¼š`excludedAccounts` æ•°ç»„
   - é”™è¯¯ç±»å‹åˆ¤æ–­ï¼šå¯é‡è¯• vs ä¸å¯é‡è¯•é”™è¯¯
   - æ”¯æŒå¤šç§è´¦æˆ·ç±»å‹ï¼šClaudeå®˜æ–¹ã€Claude Consoleã€Bedrockã€CCR

3. **éæµå¼é™çº§æœºåˆ¶** (`src/routes/api.js` ç¬¬589-743è¡Œ)
   - å½“æ‰€æœ‰æµå¼è´¦æˆ·å¤±è´¥åï¼Œè‡ªåŠ¨é™çº§ä¸ºéæµå¼è¯·æ±‚
   - ä½¿ç”¨ `retryManager` æ‰§è¡Œå¸¦é‡è¯•çš„éæµå¼è¯·æ±‚ï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - è‡ªåŠ¨å°†JSONå“åº”è½¬æ¢ä¸ºSSEæµæ ¼å¼
   - å®Œæ•´çš„usageæ•°æ®è®°å½•å’Œé™æµæ›´æ–°

4. **é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†** (`src/routes/api.js` ç¬¬745-750è¡Œ)
   - æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥åï¼Œå‘é€SSEé”™è¯¯å“åº”
   - é˜²æ­¢å“åº”å¤´å·²å‘é€çš„æƒ…å†µä¸‹é‡å¤å“åº”
   - è‡ªåŠ¨æ¸…ç†èµ„æºå’Œè®°å½•æ—¥å¿—

## ğŸ“Š é‡è¯•æµç¨‹å›¾

```
æµå¼è¯·æ±‚å¼€å§‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ æµå¼é‡è¯•å¾ªç¯ (æœ€å¤š3ä¸ªè´¦æˆ·)        â”‚
â”‚                                     â”‚
â”‚ 1. é€‰æ‹©å¯ç”¨è´¦æˆ· (æ’é™¤å¤±è´¥è´¦æˆ·)       â”‚
â”‚ 2. å°è¯•å»ºç«‹æµå¼è¿æ¥                 â”‚
â”‚ 3. æ£€æµ‹é”™è¯¯æ˜¯å¦å¯é‡è¯•               â”‚
â”‚ 4. å¤±è´¥â†’æ’é™¤è´¦æˆ·â†’ç»§ç»­å¾ªç¯           â”‚
â”‚ 5. æˆåŠŸâ†’é€€å‡ºå¾ªç¯â†’è¿”å›å“åº”           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (æ‰€æœ‰æµå¼å°è¯•éƒ½å¤±è´¥)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ éæµå¼é™çº§ (ä½¿ç”¨retryManager)    â”‚
â”‚                                     â”‚
â”‚ 1. ä½¿ç”¨retryManageræ‰§è¡Œ3æ¬¡é‡è¯•      â”‚
â”‚ 2. æ’é™¤æ‰€æœ‰å·²å¤±è´¥çš„æµå¼è´¦æˆ·         â”‚
â”‚ 3. è·å–éæµå¼JSONå“åº”               â”‚
â”‚ 4. è½¬æ¢JSONâ†’SSEæµæ ¼å¼               â”‚
â”‚ 5. è®°å½•usageæ•°æ®                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (æˆåŠŸ/å¤±è´¥)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æˆåŠŸï¼šè¿”å›SSEæµ                  â”‚
â”‚ âŒ å¤±è´¥ï¼šå‘é€SSEé”™è¯¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ å…³é”®å®ç°ç»†èŠ‚

### 1. æµå¼é‡è¯•é…ç½®
```javascript
const MAX_STREAM_RETRIES = 3  // æœ€å¤šå°è¯•3ä¸ªè´¦æˆ·
const excludedAccounts = []    // è®°å½•å¤±è´¥è´¦æˆ·
let streamRetryCount = 0       // å½“å‰é‡è¯•æ¬¡æ•°
let lastStreamError = null     // è®°å½•æœ€åçš„é”™è¯¯
let usageDataCaptured = false  // æ˜¯å¦æ•è·äº†usageæ•°æ®
```

### 2. è´¦æˆ·é€‰æ‹©å’Œæ’é™¤
```javascript
const selection = await unifiedClaudeScheduler.selectAccountForApiKey(
  req.apiKey,
  sessionHash,
  requestedModel,
  { excludedAccounts }  // ğŸ”‘ æ’é™¤å·²å¤±è´¥çš„è´¦æˆ·
)
```

### 3. é”™è¯¯åˆ¤æ–­å’Œé‡è¯•å†³ç­–
```javascript
catch (error) {
  // æ£€æŸ¥é”™è¯¯æ˜¯å¦å¯ä»¥é‡è¯•
  const isRetryable = isStreamRetryableError(error)

  if (!isRetryable) {
    logger.warn(`âš ï¸ Non-retryable stream error, stopping: ${error.message}`)
    break  // ä¸å¯é‡è¯•ï¼Œç«‹å³åœæ­¢
  }

  // æ’é™¤å¤±è´¥çš„è´¦æˆ·
  excludedAccounts.push(accountId)
  streamRetryCount++

  // ç»§ç»­é‡è¯•
  if (streamRetryCount < MAX_STREAM_RETRIES) {
    continue
  }
}
```

### 4. éæµå¼é™çº§
```javascript
const result = await retryManager.executeWithRetry(
  async (selectedAccountId, selectedAccountType) => {
    // æ‰§è¡Œéæµå¼è¯·æ±‚
    let fallbackResponse = await executeNonStreamRequest(...)
    return fallbackResponse
  },
  async (additionalExcludedAccounts) => {
    // æ’é™¤æ‰€æœ‰å·²å¤±è´¥çš„æµå¼è´¦æˆ· + é¢å¤–å¤±è´¥è´¦æˆ·
    const allExcluded = [...excludedAccounts, ...additionalExcludedAccounts]
    return await selectAccount(..., { excludedAccounts: allExcluded })
  },
  { maxRetries: 3 }  // éæµå¼ä¹Ÿæ”¯æŒ3æ¬¡é‡è¯•
)

// è½¬æ¢JSONå“åº”ä¸ºSSEæµ
await convertJsonToSSEStream(result.response, res)
```

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæµå¼è´¦æˆ·ç«‹å³æˆåŠŸ
- **æµç¨‹**ï¼šç¬¬1æ¬¡å°è¯• â†’ æˆåŠŸ â†’ é€€å‡ºå¾ªç¯ â†’ è¿”å›SSEæµ
- **é‡è¯•æ¬¡æ•°**ï¼š0æ¬¡
- **é™çº§**ï¼šæ— 

### åœºæ™¯2ï¼šç¬¬1ä¸ªè´¦æˆ·å¤±è´¥ï¼Œç¬¬2ä¸ªæˆåŠŸ
- **æµç¨‹**ï¼šç¬¬1æ¬¡å°è¯• â†’ å¤±è´¥ â†’ æ’é™¤è´¦æˆ·1 â†’ ç¬¬2æ¬¡å°è¯• â†’ æˆåŠŸ
- **é‡è¯•æ¬¡æ•°**ï¼š1æ¬¡
- **é™çº§**ï¼šæ— 

### åœºæ™¯3ï¼š3ä¸ªæµå¼è´¦æˆ·å…¨éƒ¨å¤±è´¥
- **æµç¨‹**ï¼š3æ¬¡æµå¼å°è¯•å…¨éƒ¨å¤±è´¥ â†’ é™çº§ä¸ºéæµå¼ â†’ æˆåŠŸ â†’ è½¬æ¢ä¸ºSSEæµ
- **é‡è¯•æ¬¡æ•°**ï¼š3æ¬¡æµå¼ + æœ€å¤š3æ¬¡éæµå¼ = æœ€å¤š6æ¬¡
- **é™çº§**ï¼šæ˜¯

### åœºæ™¯4ï¼šæ‰€æœ‰å°è¯•éƒ½å¤±è´¥
- **æµç¨‹**ï¼š3æ¬¡æµå¼å¤±è´¥ â†’ 3æ¬¡éæµå¼å¤±è´¥ â†’ å‘é€SSEé”™è¯¯
- **é‡è¯•æ¬¡æ•°**ï¼š6æ¬¡
- **ç»“æœ**ï¼šè¿”å›é”™è¯¯

## ğŸ“ˆ æ€§èƒ½å’Œå®¹é”™

### ä¼˜åŠ¿
1. **é«˜å¯ç”¨æ€§**ï¼šæœ€å¤š6æ¬¡é‡è¯•æœºä¼šï¼ˆ3æ¬¡æµå¼ + 3æ¬¡éæµå¼ï¼‰
2. **æ™ºèƒ½åˆ‡æ¢**ï¼šè‡ªåŠ¨è¯†åˆ«å¯é‡è¯•é”™è¯¯ï¼Œé¿å…æ— æ•ˆé‡è¯•
3. **è´¦æˆ·éš”ç¦»**ï¼šå¤±è´¥è´¦æˆ·è¢«æ’é™¤ï¼Œä¸ä¼šé‡å¤ä½¿ç”¨
4. **æ— ç¼é™çº§**ï¼šæµå¼å¤±è´¥åè‡ªåŠ¨è½¬ä¸ºéæµå¼ï¼Œå¯¹å®¢æˆ·ç«¯é€æ˜

### æ—¥å¿—è·Ÿè¸ª
```
ğŸŒŠ Starting stream request with retry support (max 3 accounts)
ğŸ¯ Stream attempt 1/3 using account: xxx (claude-official)
âŒ Stream attempt 1 failed: Connection timeout
ğŸ”„ Excluded account xxx, will try another account
ğŸ¯ Stream attempt 2/3 using account: yyy (claude-console)
âŒ Stream attempt 2 failed: 503 Service Unavailable
âš ï¸ All 3 stream attempts failed, attempting non-stream fallback...
ğŸ”„ Non-stream fallback attempt using account: zzz (bedrock)
âœ… Non-stream fallback succeeded, converting to SSE format
ğŸ“Š Stream fallback usage recorded - Model: claude-sonnet-4, Total: 5234 tokens
```

## ğŸš€ éƒ¨ç½²å’Œä½¿ç”¨

### æ— éœ€é¢å¤–é…ç½®
æµå¼é‡è¯•æœºåˆ¶å·²ç»é›†æˆåˆ°ç°æœ‰çš„ `/api/v1/messages` å’Œ `/claude/v1/messages` ç«¯ç‚¹ä¸­ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆã€‚

### å…¼å®¹æ€§
- âœ… æ”¯æŒæ‰€æœ‰è´¦æˆ·ç±»å‹ï¼šClaudeå®˜æ–¹ã€Claude Consoleã€Bedrockã€CCR
- âœ… å‘åå…¼å®¹ï¼šä¸å½±å“ç°æœ‰çš„éæµå¼è¯·æ±‚é€»è¾‘
- âœ… å®¢æˆ·ç«¯é€æ˜ï¼šå®¢æˆ·ç«¯æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `src/routes/api.js` - ä¸»è¦å®ç°ï¼ˆç¬¬139-759è¡Œï¼‰
- `src/utils/sseConverter.js` - SSEè½¬æ¢å·¥å…·
- `src/utils/retryManager.js` - é‡è¯•ç®¡ç†å™¨
- `src/utils/requestQueue.js` - è¯·æ±‚é˜Ÿåˆ—ç®¡ç†

## âœ… å®ç°å®Œæˆç¡®è®¤

- [x] æµå¼é‡è¯•å¾ªç¯
- [x] è´¦æˆ·é€‰æ‹©å’Œæ’é™¤
- [x] é”™è¯¯ç±»å‹åˆ¤æ–­
- [x] éæµå¼é™çº§
- [x] JSONåˆ°SSEè½¬æ¢
- [x] Usageæ•°æ®è®°å½•
- [x] é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†
- [x] ESLintæ£€æŸ¥é€šè¿‡
- [x] æ–‡æ¡£æ›´æ–°

**å®ç°çŠ¶æ€ï¼šâœ… å®Œæˆ**

**å®ç°æ—¥æœŸï¼š** 2025-01-11
**å®ç°äººå‘˜ï¼š** Claude Code AI Assistant

