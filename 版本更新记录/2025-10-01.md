
## 版本更新记录

### 2025-10-01: Claude Code 2.0.1 支持与动态 User-Agent

#### 背景
Claude Code 终端更新到 2.0.1 版本，新增了 Sonnet 4.5 (claude-sonnet-4-5-20250929) 模型。需要根据不同模型动态设置对应的 User-Agent 版本。

#### 修改内容

##### 1. 动态 User-Agent 逻辑 (claudeCodeHeadersService.js)

新增 `getUserAgentForModel()` 方法，根据模型自动选择正确的 User-Agent：

```javascript
// 位置：src/services/claudeCodeHeadersService.js:155-169
getUserAgentForModel(model) {
  // Sonnet 4 精确匹配 (claude-sonnet-4-20250514)
  if (modelLower.includes('claude-sonnet-4-20250514')) {
    return 'claude-cli/1.0.119 (external, cli)'
  }

  // 所有其他模型（Sonnet 4.5+、Opus、Haiku 等）
  return 'claude-cli/2.0.1 (external, cli)'
}
```

**版本映射规则：**
- ✅ `claude-sonnet-4-20250514` → `claude-cli/1.0.119 (external, cli)`
- ✅ `claude-sonnet-4-5-*` (4.5 及以后) → `claude-cli/2.0.1 (external, cli)`
- ✅ `claude-opus-*` → `claude-cli/2.0.1 (external, cli)`
- ✅ `claude-haiku-*` → `claude-cli/2.0.1 (external, cli)`
- ✅ 其他所有模型 → `claude-cli/2.0.1 (external, cli)` (默认)

##### 2. 请求头完整性更新 (claudeCodeHeadersService.js)

更新 `defaultHeaders` 以匹配最新的 Claude Code 2.0.1 请求头：

```javascript
// 位置：src/services/claudeCodeHeadersService.js:11-31
this.defaultHeaders = {
  connection: 'keep-alive',                    // 新增
  accept: 'application/json',                  // 新增
  'x-stainless-retry-count': '0',
  'x-stainless-timeout': '600',                // 从 60 更新
  'x-stainless-lang': 'js',
  'x-stainless-package-version': '0.60.0',     // 从 0.55.1 更新
  'x-stainless-os': 'Windows',
  'x-stainless-arch': 'x64',
  'x-stainless-runtime': 'node',
  'x-stainless-runtime-version': 'v20.19.1',   // 从 v20.19.2 更新
  'anthropic-dangerous-direct-browser-access': 'true',
  'x-app': 'cli',
  'user-agent': 'claude-cli/1.0.119 (external, cli)',
  'accept-language': '*',
  'sec-fetch-mode': 'cors',
  'accept-encoding': 'br, gzip, deflate',      // 新增
  'anthropic-beta': 'claude-code-20250219,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14',
  'x-stainless-helper-method': 'stream'
}
```

**更新项：**
- ✅ 新增 `connection: keep-alive`
- ✅ 新增 `accept: application/json`
- ✅ 新增 `accept-encoding: br, gzip, deflate`
- ✅ 更新 `x-stainless-timeout: 600` (原 60)
- ✅ 更新 `x-stainless-package-version: 0.60.0` (原 0.55.1)
- ✅ 更新 `x-stainless-runtime-version: v20.19.1` (原 v20.19.2)

##### 3. getAccountHeaders() 方法增强 (claudeCodeHeadersService.js)

修改 `getAccountHeaders()` 方法签名，支持传入 model 参数：

```javascript
// 位置：src/services/claudeCodeHeadersService.js:267
async getAccountHeaders(accountId, account = null, model = null) {
  // ... 原有逻辑 ...

  // 根据模型动态设置 User-Agent
  if (model) {
    const userAgent = this.getUserAgentForModel(model)
    headers['user-agent'] = userAgent
    logger.debug(`🔄 Set User-Agent for model ${model}: ${userAgent}`)
  }

  return headers
}
```

**特性：**
- ✅ 每次请求根据当前模型重新计算 User-Agent（不会缓存旧值）
- ✅ 用户切换模型时自动使用正确的版本
- ✅ 向后兼容：不传 model 参数时使用默认版本

##### 4. 调用点更新

更新所有 `getAccountHeaders()` 调用，传入 model 参数：

**claudeRelayService.js (2处):**
```javascript
// 位置：src/services/claudeRelayService.js:713, 993
const claudeCodeHeaders = await claudeCodeHeadersService.getAccountHeaders(
  accountId,
  account,
  body.model  // 传入模型参数
)
```

**openaiClaudeRoutes.js (1处):**
```javascript
// 位置：src/routes/openaiClaudeRoutes.js:222
const claudeCodeHeaders = await claudeCodeHeadersService.getAccountHeaders(
  accountId,
  account,
  claudeRequest.model  // 传入模型参数
)
```

#### 技术细节

##### Host 头处理
- ❌ **不需要手动设置** `host` 头
- ✅ Node.js 的 `https` 模块会根据目标 URL 自动设置
- ✅ 官方 API (`api.anthropic.com`) → 自动设置 `host: api.anthropic.com`
- ✅ 自定义上游 (`jp.duckcoding.com`) → 自动设置 `host: jp.duckcoding.com`

##### User-Agent 切换机制
```
请求1: Sonnet 4 (claude-sonnet-4-20250514)
  → User-Agent: claude-cli/1.0.119 (external, cli)

请求2: Opus (claude-opus-4-20250514)
  → User-Agent: claude-cli/2.0.1 (external, cli)

请求3: Sonnet 4 (claude-sonnet-4-20250514)
  → User-Agent: claude-cli/1.0.119 (external, cli)
```

每个请求独立计算，不会互相影响。

#### 影响范围

**✅ 受影响的文件：**
1. `src/services/claudeCodeHeadersService.js` - 核心逻辑
2. `src/services/claudeRelayService.js` - Claude OAuth 请求代理
3. `src/services/claudeConsoleRelayService.js` - Claude Console 请求代理
4. `src/routes/openaiClaudeRoutes.js` - OpenAI 兼容路由

**✅ 兼容性：**
- ✅ 向后兼容旧版本客户端
- ✅ 不影响现有账户配置
- ✅ 特殊供应商（instcopilot、anyrouter、gaccode）继续正常工作

#### 测试建议

```bash
# 1. 测试 Sonnet 4 模型（应使用 1.0.119）
curl -X POST http://localhost:3000/api/v1/messages \
  -H "Authorization: Bearer cr_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4-20250514",
    "messages": [{"role": "user", "content": "hello"}]
  }'

# 2. 测试 Sonnet 4.5 模型（应使用 2.0.1）
curl -X POST http://localhost:3000/api/v1/messages \
  -H "Authorization: Bearer cr_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4-5-20250929",
    "messages": [{"role": "user", "content": "hello"}]
  }'

# 3. 检查日志确认 User-Agent
tail -f logs/claude-relay-*.log | grep "User-Agent"
```

#### 相关问题解答

**Q: 如果用户频繁切换模型，会有性能问题吗？**
A: 不会。User-Agent 的计算是基于字符串匹配的轻量级操作，性能影响可以忽略不计。

**Q: 为什么只有 Sonnet 4 使用 1.0.119？**
A: 根据 Anthropic 的要求，Sonnet 4 (20250514) 需要使用旧版 API 客户端，而更新的模型（4.5+）需要使用新版客户端。

**Q: 如果未来出现 Sonnet 4.6、5.0 等新模型？**
A: 当前逻辑会自动将它们识别为新版本，使用 `claude-cli/2.0.1`。只需要关注是否有新的特定版本需求。
