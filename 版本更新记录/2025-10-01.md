
## ç‰ˆæœ¬æ›´æ–°è®°å½•

### 2025-10-01: Claude Code 2.0.1 æ”¯æŒä¸åŠ¨æ€ User-Agent

#### èƒŒæ™¯
Claude Code ç»ˆç«¯æ›´æ–°åˆ° 2.0.1 ç‰ˆæœ¬ï¼Œæ–°å¢äº† Sonnet 4.5 (claude-sonnet-4-5-20250929) æ¨¡å‹ã€‚éœ€è¦æ ¹æ®ä¸åŒæ¨¡å‹åŠ¨æ€è®¾ç½®å¯¹åº”çš„ User-Agent ç‰ˆæœ¬ã€‚

#### ä¿®æ”¹å†…å®¹

##### 1. åŠ¨æ€ User-Agent é€»è¾‘ (claudeCodeHeadersService.js)

æ–°å¢ `getUserAgentForModel()` æ–¹æ³•ï¼Œæ ¹æ®æ¨¡å‹è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„ User-Agentï¼š

```javascript
// ä½ç½®ï¼šsrc/services/claudeCodeHeadersService.js:155-169
getUserAgentForModel(model) {
  // Sonnet 4 ç²¾ç¡®åŒ¹é… (claude-sonnet-4-20250514)
  if (modelLower.includes('claude-sonnet-4-20250514')) {
    return 'claude-cli/1.0.119 (external, cli)'
  }

  // æ‰€æœ‰å…¶ä»–æ¨¡å‹ï¼ˆSonnet 4.5+ã€Opusã€Haiku ç­‰ï¼‰
  return 'claude-cli/2.0.1 (external, cli)'
}
```

**ç‰ˆæœ¬æ˜ å°„è§„åˆ™ï¼š**
- âœ… `claude-sonnet-4-20250514` â†’ `claude-cli/1.0.119 (external, cli)`
- âœ… `claude-sonnet-4-5-*` (4.5 åŠä»¥å) â†’ `claude-cli/2.0.1 (external, cli)`
- âœ… `claude-opus-*` â†’ `claude-cli/2.0.1 (external, cli)`
- âœ… `claude-haiku-*` â†’ `claude-cli/2.0.1 (external, cli)`
- âœ… å…¶ä»–æ‰€æœ‰æ¨¡å‹ â†’ `claude-cli/2.0.1 (external, cli)` (é»˜è®¤)

##### 2. è¯·æ±‚å¤´å®Œæ•´æ€§æ›´æ–° (claudeCodeHeadersService.js)

æ›´æ–° `defaultHeaders` ä»¥åŒ¹é…æœ€æ–°çš„ Claude Code 2.0.1 è¯·æ±‚å¤´ï¼š

```javascript
// ä½ç½®ï¼šsrc/services/claudeCodeHeadersService.js:11-31
this.defaultHeaders = {
  connection: 'keep-alive',                    // æ–°å¢
  accept: 'application/json',                  // æ–°å¢
  'x-stainless-retry-count': '0',
  'x-stainless-timeout': '600',                // ä» 60 æ›´æ–°
  'x-stainless-lang': 'js',
  'x-stainless-package-version': '0.60.0',     // ä» 0.55.1 æ›´æ–°
  'x-stainless-os': 'Windows',
  'x-stainless-arch': 'x64',
  'x-stainless-runtime': 'node',
  'x-stainless-runtime-version': 'v20.19.1',   // ä» v20.19.2 æ›´æ–°
  'anthropic-dangerous-direct-browser-access': 'true',
  'x-app': 'cli',
  'user-agent': 'claude-cli/1.0.119 (external, cli)',
  'accept-language': '*',
  'sec-fetch-mode': 'cors',
  'accept-encoding': 'br, gzip, deflate',      // æ–°å¢
  'anthropic-beta': 'claude-code-20250219,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14',
  'x-stainless-helper-method': 'stream'
}
```

**æ›´æ–°é¡¹ï¼š**
- âœ… æ–°å¢ `connection: keep-alive`
- âœ… æ–°å¢ `accept: application/json`
- âœ… æ–°å¢ `accept-encoding: br, gzip, deflate`
- âœ… æ›´æ–° `x-stainless-timeout: 600` (åŸ 60)
- âœ… æ›´æ–° `x-stainless-package-version: 0.60.0` (åŸ 0.55.1)
- âœ… æ›´æ–° `x-stainless-runtime-version: v20.19.1` (åŸ v20.19.2)

##### 3. getAccountHeaders() æ–¹æ³•å¢å¼º (claudeCodeHeadersService.js)

ä¿®æ”¹ `getAccountHeaders()` æ–¹æ³•ç­¾åï¼Œæ”¯æŒä¼ å…¥ model å‚æ•°ï¼š

```javascript
// ä½ç½®ï¼šsrc/services/claudeCodeHeadersService.js:267
async getAccountHeaders(accountId, account = null, model = null) {
  // ... åŸæœ‰é€»è¾‘ ...

  // æ ¹æ®æ¨¡å‹åŠ¨æ€è®¾ç½® User-Agent
  if (model) {
    const userAgent = this.getUserAgentForModel(model)
    headers['user-agent'] = userAgent
    logger.debug(`ğŸ”„ Set User-Agent for model ${model}: ${userAgent}`)
  }

  return headers
}
```

**ç‰¹æ€§ï¼š**
- âœ… æ¯æ¬¡è¯·æ±‚æ ¹æ®å½“å‰æ¨¡å‹é‡æ–°è®¡ç®— User-Agentï¼ˆä¸ä¼šç¼“å­˜æ—§å€¼ï¼‰
- âœ… ç”¨æˆ·åˆ‡æ¢æ¨¡å‹æ—¶è‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬
- âœ… å‘åå…¼å®¹ï¼šä¸ä¼  model å‚æ•°æ—¶ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬

##### 4. è°ƒç”¨ç‚¹æ›´æ–°

æ›´æ–°æ‰€æœ‰ `getAccountHeaders()` è°ƒç”¨ï¼Œä¼ å…¥ model å‚æ•°ï¼š

**claudeRelayService.js (2å¤„):**
```javascript
// ä½ç½®ï¼šsrc/services/claudeRelayService.js:713, 993
const claudeCodeHeaders = await claudeCodeHeadersService.getAccountHeaders(
  accountId,
  account,
  body.model  // ä¼ å…¥æ¨¡å‹å‚æ•°
)
```

**openaiClaudeRoutes.js (1å¤„):**
```javascript
// ä½ç½®ï¼šsrc/routes/openaiClaudeRoutes.js:222
const claudeCodeHeaders = await claudeCodeHeadersService.getAccountHeaders(
  accountId,
  account,
  claudeRequest.model  // ä¼ å…¥æ¨¡å‹å‚æ•°
)
```

#### æŠ€æœ¯ç»†èŠ‚

##### Host å¤´å¤„ç†
- âŒ **ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®** `host` å¤´
- âœ… Node.js çš„ `https` æ¨¡å—ä¼šæ ¹æ®ç›®æ ‡ URL è‡ªåŠ¨è®¾ç½®
- âœ… å®˜æ–¹ API (`api.anthropic.com`) â†’ è‡ªåŠ¨è®¾ç½® `host: api.anthropic.com`
- âœ… è‡ªå®šä¹‰ä¸Šæ¸¸ (`jp.duckcoding.com`) â†’ è‡ªåŠ¨è®¾ç½® `host: jp.duckcoding.com`

##### User-Agent åˆ‡æ¢æœºåˆ¶
```
è¯·æ±‚1: Sonnet 4 (claude-sonnet-4-20250514)
  â†’ User-Agent: claude-cli/1.0.119 (external, cli)

è¯·æ±‚2: Opus (claude-opus-4-20250514)
  â†’ User-Agent: claude-cli/2.0.1 (external, cli)

è¯·æ±‚3: Sonnet 4 (claude-sonnet-4-20250514)
  â†’ User-Agent: claude-cli/1.0.119 (external, cli)
```

æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹è®¡ç®—ï¼Œä¸ä¼šäº’ç›¸å½±å“ã€‚

#### å½±å“èŒƒå›´

**âœ… å—å½±å“çš„æ–‡ä»¶ï¼š**
1. `src/services/claudeCodeHeadersService.js` - æ ¸å¿ƒé€»è¾‘
2. `src/services/claudeRelayService.js` - Claude OAuth è¯·æ±‚ä»£ç†
3. `src/services/claudeConsoleRelayService.js` - Claude Console è¯·æ±‚ä»£ç†
4. `src/routes/openaiClaudeRoutes.js` - OpenAI å…¼å®¹è·¯ç”±

**âœ… å…¼å®¹æ€§ï¼š**
- âœ… å‘åå…¼å®¹æ—§ç‰ˆæœ¬å®¢æˆ·ç«¯
- âœ… ä¸å½±å“ç°æœ‰è´¦æˆ·é…ç½®
- âœ… ç‰¹æ®Šä¾›åº”å•†ï¼ˆinstcopilotã€anyrouterã€gaccodeï¼‰ç»§ç»­æ­£å¸¸å·¥ä½œ

#### æµ‹è¯•å»ºè®®

```bash
# 1. æµ‹è¯• Sonnet 4 æ¨¡å‹ï¼ˆåº”ä½¿ç”¨ 1.0.119ï¼‰
curl -X POST http://localhost:3000/api/v1/messages \
  -H "Authorization: Bearer cr_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4-20250514",
    "messages": [{"role": "user", "content": "hello"}]
  }'

# 2. æµ‹è¯• Sonnet 4.5 æ¨¡å‹ï¼ˆåº”ä½¿ç”¨ 2.0.1ï¼‰
curl -X POST http://localhost:3000/api/v1/messages \
  -H "Authorization: Bearer cr_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4-5-20250929",
    "messages": [{"role": "user", "content": "hello"}]
  }'

# 3. æ£€æŸ¥æ—¥å¿—ç¡®è®¤ User-Agent
tail -f logs/claude-relay-*.log | grep "User-Agent"
```

#### ç›¸å…³é—®é¢˜è§£ç­”

**Q: å¦‚æœç”¨æˆ·é¢‘ç¹åˆ‡æ¢æ¨¡å‹ï¼Œä¼šæœ‰æ€§èƒ½é—®é¢˜å—ï¼Ÿ**
A: ä¸ä¼šã€‚User-Agent çš„è®¡ç®—æ˜¯åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è½»é‡çº§æ“ä½œï¼Œæ€§èƒ½å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

**Q: ä¸ºä»€ä¹ˆåªæœ‰ Sonnet 4 ä½¿ç”¨ 1.0.119ï¼Ÿ**
A: æ ¹æ® Anthropic çš„è¦æ±‚ï¼ŒSonnet 4 (20250514) éœ€è¦ä½¿ç”¨æ—§ç‰ˆ API å®¢æˆ·ç«¯ï¼Œè€Œæ›´æ–°çš„æ¨¡å‹ï¼ˆ4.5+ï¼‰éœ€è¦ä½¿ç”¨æ–°ç‰ˆå®¢æˆ·ç«¯ã€‚

**Q: å¦‚æœæœªæ¥å‡ºç° Sonnet 4.6ã€5.0 ç­‰æ–°æ¨¡å‹ï¼Ÿ**
A: å½“å‰é€»è¾‘ä¼šè‡ªåŠ¨å°†å®ƒä»¬è¯†åˆ«ä¸ºæ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ `claude-cli/2.0.1`ã€‚åªéœ€è¦å…³æ³¨æ˜¯å¦æœ‰æ–°çš„ç‰¹å®šç‰ˆæœ¬éœ€æ±‚ã€‚
