# 🚀 Claude Relay Service Configuration

# 🌐 服务器配置
PORT=3000
HOST=0.0.0.0
NODE_ENV=production

# 🔐 安全配置
JWT_SECRET=your-jwt-secret-here
ADMIN_SESSION_TIMEOUT=86400000
API_KEY_PREFIX=cr_
ENCRYPTION_KEY=your-encryption-key-here

# 👤 管理员凭据（可选，不设置则自动生成）
# ADMIN_USERNAME=cr_admin_custom
# ADMIN_PASSWORD=your-secure-password

# 📊 Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_ENABLE_TLS=

# 🔗 会话管理配置
# 粘性会话TTL配置（小时），默认1小时
STICKY_SESSION_TTL_HOURS=1
# 续期阈值（分钟），默认0分钟（不续期）
STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES=15

# 🎯 Claude API 配置
CLAUDE_API_URL=https://api.anthropic.com/v1/messages
CLAUDE_API_VERSION=2023-06-01
CLAUDE_BETA_HEADER=claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14

# 🚫 529错误处理配置
# 启用529错误处理，0表示禁用，>0表示过载状态持续时间（分钟）
CLAUDE_OVERLOAD_HANDLING_MINUTES=0

# 400错误处理：0表示禁用，>0表示临时禁用时间（分钟）
# 只有匹配特定错误模式的 400 才会触发临时禁用
#  - organization has been disabled
#  - account has been disabled
#  - account is disabled
#  - no account supporting
#  - account not found
#  - invalid account
#  - Too many active sessions
CLAUDE_CONSOLE_BLOCKED_HANDLING_MINUTES=10

# 🌐 代理配置
DEFAULT_PROXY_TIMEOUT=600000
MAX_PROXY_RETRIES=3
# IP协议族配置：true=IPv4, false=IPv6, 默认IPv4（兼容性更好）
PROXY_USE_IPV4=true

# ⏱️ 请求超时配置
REQUEST_TIMEOUT=600000  # 请求超时设置（毫秒），默认10分钟

# 🔥 流式请求超时配置（针对大模型的特殊超时监控）
STREAM_TOTAL_TIMEOUT=180000  # 绝对超时（毫秒），默认3分钟
STREAM_IDLE_TIMEOUT=30000    # 空闲超时（毫秒），默认30秒
STREAM_TIMEOUT_ENABLED=true  # 是否启用超时监控

# 🔄 服务器端重试配置（针对非流式请求的智能重试机制）
SERVER_RETRY_ENABLED=true           # 是否启用服务器端重试（默认启用）
SERVER_MAX_RETRIES=3                # 5xx错误最大重试次数（同一账户立即重试）
SERVER_RETRY_TIMEOUT=180000         # 请求超时时间（毫秒），超时后切换账户
SERVER_CACHE_TTL=300                # 响应缓存TTL（秒），成功响应缓存5分钟
SERVER_ENABLE_REQUEST_QUEUE=true    # 是否启用请求去重和合并（相同请求共享结果）

# 📈 使用限制
DEFAULT_TOKEN_LIMIT=1000000

# 📝 日志配置
LOG_LEVEL=info
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# 🔧 系统配置
CLEANUP_INTERVAL=3600000
TOKEN_USAGE_RETENTION=2592000000
HEALTH_CHECK_INTERVAL=60000
TIMEZONE_OFFSET=8  # UTC偏移小时数，默认+8（中国时区）
METRICS_WINDOW=5  # 实时指标统计窗口（分钟），可选1-60，默认5分钟

# 🎨 Web 界面配置
WEB_TITLE=Claude Relay Service
WEB_DESCRIPTION=Multi-account Claude API relay service with beautiful management interface
WEB_LOGO_URL=/assets/logo.png

# 🛠️ 开发配置
DEBUG=false
DEBUG_HTTP_TRAFFIC=false  # 启用HTTP请求/响应调试日志（仅开发环境）
ENABLE_CORS=true
TRUST_PROXY=true

# 🔒 客户端限制（可选）
# ALLOW_CUSTOM_CLIENTS=false

# 🔐 LDAP 认证配置
LDAP_ENABLED=false
LDAP_URL=ldaps://ldap-1.test1.bj.yxops.net:636
LDAP_BIND_DN=cn=admin,dc=example,dc=com
LDAP_BIND_PASSWORD=admin_password
LDAP_SEARCH_BASE=dc=example,dc=com
LDAP_SEARCH_FILTER=(uid={{username}})
LDAP_SEARCH_ATTRIBUTES=dn,uid,cn,mail,givenName,sn
LDAP_TIMEOUT=5000
LDAP_CONNECT_TIMEOUT=10000

# 🔒 LDAP TLS/SSL 配置 (用于 ldaps:// URL)
# 是否忽略证书验证错误 (设置为false可忽略自签名证书错误)
LDAP_TLS_REJECT_UNAUTHORIZED=true
# CA 证书文件路径 (可选，用于自定义CA证书)
# LDAP_TLS_CA_FILE=/path/to/ca-cert.pem
# 客户端证书文件路径 (可选，用于双向认证)
# LDAP_TLS_CERT_FILE=/path/to/client-cert.pem
# 客户端私钥文件路径 (可选，用于双向认证)
# LDAP_TLS_KEY_FILE=/path/to/client-key.pem
# 服务器名称 (可选，用于 SNI)
# LDAP_TLS_SERVERNAME=ldap.example.com

# 🗺️ LDAP 用户属性映射
LDAP_USER_ATTR_USERNAME=uid
LDAP_USER_ATTR_DISPLAY_NAME=cn
LDAP_USER_ATTR_EMAIL=mail
LDAP_USER_ATTR_FIRST_NAME=givenName
LDAP_USER_ATTR_LAST_NAME=sn

# 👥 用户管理配置
USER_MANAGEMENT_ENABLED=false
DEFAULT_USER_ROLE=user
USER_SESSION_TIMEOUT=86400000
MAX_API_KEYS_PER_USER=1
ALLOW_USER_DELETE_API_KEYS=false

# 🛡️ 内容审核配置
CONTENT_MODERATION_ENABLED=false
MODERATION_API_BASE_URL=https://api.siliconflow.cn

# 🔑 审核API Key配置（支持多Key轮询，应对RPM/TPM限流）
# 方式1：单个Key（向后兼容）
MODERATION_API_KEY=sk-your-api-key-here
# 方式2：多个Key（推荐，逗号分隔，自动去除空格）
# MODERATION_API_KEY=sk-key1,sk-key2,sk-key3
# 或使用别名
# MODERATION_API_KEYS=sk-key1,sk-key2,sk-key3

MODERATION_MAX_TOKENS=100
MODERATION_TIMEOUT=10000
# ✂️ 内容截断配置：审核时截取的最大字符数（默认100字符，减少token消耗和TPM压力）
MODERATION_MAX_CONTENT_LENGTH=100
MODERATION_MODEL=Qwen/Qwen3-Coder-30B-A3B-Instruct
MODERATION_PRO_MODEL=Pro/deepseek-ai/DeepSeek-V3.2-Exp
MODERATION_ADVANCED_MODEL=Qwen/Qwen3-Coder-480B-A35B-Instruct
MODERATION_ENABLE_SECOND_CHECK=true  # 默认true，可设false禁用

# 🔄 审核重试配置
MODERATION_MAX_RETRIES=3             # 单个模型最多重试次数（默认模型失败后切换到Pro模型）
MODERATION_RETRY_DELAY=5000          # 重试间隔（毫秒，会递增：5s, 10s）
MODERATION_FAIL_STRATEGY=fail-close  # 故障策略: fail-close（��绝请求，默认）或 fail-open（放行请求）

# 🔥 审核熔断机制配置（检测到故障后自动停用审核一段时间，避免每次请求都等待超时）
MODERATION_CIRCUIT_BREAKER_ENABLED=true   # 是否启用熔断机制（默认true）
MODERATION_CIRCUIT_BREAKER_DURATION=300000 # 熔断持续时间（毫秒，默认300000=5分钟）

# 非流式请求：客户端断开后等待上游响应的时间（毫秒）
UPSTREAM_WAIT_NON_STREAM=180000
# 流式请求：客户端断开后等待上游响应的时间（毫秒）
UPSTREAM_WAIT_STREAM=180000
# 是否启用延迟取消（设置为false则立即取消）
UPSTREAM_WAIT_ENABLED=true

# 流式请求超时配置（针对大模型的特殊超时监控）
STREAM_TOTAL_TIMEOUT=180000  # 绝对超时（毫秒），默认3分钟
STREAM_IDLE_TIMEOUT=30000    # 空闲超时（毫秒），默认30秒
STREAM_TIMEOUT_ENABLED=true  # 是否启用超时监控

# 服务器端重试配置（针对非流式请求的智能重试机制）
SERVER_RETRY_ENABLED=true           # 是否启用服务器端重试（默认启用）
SERVER_MAX_RETRIES=3                # 5xx错误最大重试次数（同一账户立即重试）
SERVER_RETRY_TIMEOUT=180000         # 请求超时时间（毫秒），超时后切换账户
SERVER_CACHE_TTL=300                # 响应缓存TTL（秒），成功响应缓存5分钟
SERVER_ENABLE_REQUEST_QUEUE=true    # 是否启用请求去重和合并（相同请求共享结果）

# 粘性并发守护（可选）
STICKY_CONCURRENCY_WAIT_ENABLED=true
STICKY_CONCURRENCY_MAX_WAIT_MS=30000 #在这个时间内只要发现并发恢复，就继续复用原账号；超过 30 秒还没有空位，就会清除粘性映射并改用其他可用账号，避免请求一直排队。
STICKY_CONCURRENCY_POLL_INTERVAL_MS=1000 # （默认1秒）轮询查看并发是否下降。

# 智能缓存优化配置
SMART_CACHE_ENABLED=true                # 是否启用（默认 true）
SMART_CACHE_TIME_WINDOW=5               # 时间窗口（分钟，默认 5）
SMART_CACHE_INPUT_THRESHOLD=0.2         # 输入差异阈值（默认 20%）
SMART_CACHE_CREATE_THRESHOLD=0.15       # 缓存差异阈值（默认 15%）
SMART_CACHE_DISCOUNT_RATIO=0.7          # 折扣比例（默认 70%）
SMART_CACHE_MIN_TOKENS=10000            # 最小缓存 tokens（默认 10000）